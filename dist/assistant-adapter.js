import{R as o,j as e,s as re,c as ge}from"./assets/assistant-Drm5Tu3d.js";var F=typeof globalThis<"u"?globalThis:window,xe=F.process||{env:{NODE_ENV:"production"}},fe=F.global||F;F.process=xe;F.global=fe;const j={Search:n=>e.jsxs("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"11",cy:"11",r:"7"}),e.jsx("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]}),Reset:n=>e.jsxs("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"1 4 1 10 7 10"}),e.jsx("path",{d:"M3.51 15a9 9 0 1 0 2.13-9.36L1 10"})]}),Restart:n=>e.jsxs("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("path",{d:"M20.49 15a9 9 0 1 1-2.13-9.36L23 10"})]}),Copy:n=>e.jsxs("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),e.jsx("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})]}),Check:n=>e.jsx("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})}),File:n=>e.jsxs("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"})]}),ChevronRight:n=>e.jsx("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),ArrowLeft:n=>e.jsxs("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"}),e.jsx("polyline",{points:"12 19 5 12 12 5"})]}),Home:n=>e.jsxs("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 11l9-7 9 7"}),e.jsx("path",{d:"M9 22V12h6v10"})]}),Close:n=>e.jsxs("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]}),Maximize:n=>e.jsxs("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"15 3 21 3 21 9"}),e.jsx("line",{x1:"14",y1:"10",x2:"21",y2:"3"}),e.jsx("polyline",{points:"9 21 3 21 3 15"}),e.jsx("line",{x1:"10",y1:"14",x2:"3",y2:"21"})]}),Minimize:n=>e.jsxs("svg",{...n,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"9 3 3 3 3 9"}),e.jsx("line",{x1:"10",y1:"10",x2:"3",y2:"3"}),e.jsx("polyline",{points:"15 21 21 21 21 15"}),e.jsx("line",{x1:"14",y1:"14",x2:"21",y2:"21"})]})};async function ye(n){try{return await navigator.clipboard.writeText(n),!0}catch{try{const i=document.createElement("textarea");return i.value=n,i.style.position="fixed",i.style.left="-9999px",document.body.appendChild(i),i.select(),document.execCommand("copy"),document.body.removeChild(i),!0}catch{return!1}}}const k=(n="")=>n.toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();function ie({text:n="",query:i=""}){const c=(i||"").trim();if(!c||c.length<3)return e.jsx(e.Fragment,{children:n});const h=S=>S.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),N=new RegExp(`(${h(c)})`,"ig"),v=String(n).replace(N,"<mark>$1</mark>");return e.jsx("span",{dangerouslySetInnerHTML:{__html:v}})}function je({def:n}){const[i,c]=o.useState(!1),h=Object.keys(n?.langs||{}),N=h.includes("fr")?"fr":h[0]||"fr",[v,S]=o.useState(N),[p,g]=o.useState(n?.langs?.[N]||""),w=o.useRef(null);o.useEffect(()=>{g(n?.langs?.[v]||"")},[v,n]);const d=280,y=o.useCallback(()=>{const u=w.current;if(!u)return;u.style.height="auto";const f=Math.min(u.scrollHeight,d);u.style.height=f+"px",u.style.overflowY=u.scrollHeight>d?"auto":"hidden"},[]);o.useEffect(()=>{y()},[p,y]),o.useEffect(()=>{y()},[]);const m=async()=>{await ye(p)&&(c(!0),setTimeout(()=>c(!1),1200))},E=()=>g(n?.langs?.[v]||"");return e.jsxs("div",{className:"tpl-shell",children:[e.jsxs("div",{className:"tpl-top",children:[e.jsx("div",{className:"tpl-meta",children:e.jsx("div",{className:"tpl-title",children:n?.label||"Message"})}),e.jsx("div",{className:"lang-pills",children:h.map(u=>e.jsx("button",{className:`lang-pill ${u===v?"active":""}`,onClick:()=>S(u),title:u.toUpperCase(),children:u.toUpperCase()},u))})]}),e.jsx("textarea",{ref:w,className:"tpl-code",value:p,onChange:u=>g(u.target.value),spellCheck:"true","aria-label":"Message éditable",style:{height:"auto",maxHeight:d,overflowY:"hidden"}}),e.jsxs("div",{className:"tpl-bottom",children:[e.jsxs("button",{className:"tpl-btn",onClick:E,title:"Réinitialiser",children:[e.jsx(j.Reset,{style:{marginRight:8}})," ",e.jsx("span",{children:"Réinitialiser"})]}),e.jsxs("button",{className:`tpl-btn ${i?"success":""}`,onClick:m,title:i?"Copié":"Copier",children:[i?e.jsx(j.Check,{style:{marginRight:8}}):e.jsx(j.Copy,{style:{marginRight:8}}),e.jsx("span",{children:i?"Copié":"Copier"})]})]})]})}function I({role:n="asst",children:i,wide:c=!1}){return e.jsx("div",{className:`chat-turn ${n==="user"?"user":"asst"}`,children:e.jsx("div",{className:`chat-msg ${c?"wide":""}`,style:c?{maxWidth:"80%",width:"80%",flexBasis:"80%"}:void 0,children:i})})}function ve({open:n,onClose:i,processes:c,templatesBySlug:h,__flowsUrl:N,__logoUrl:v="/logo.png",__headerless:S=!1}){const p=!!S,[g,w]=o.useState("idle"),[d,y]=o.useState(""),[m,E]=o.useState(""),[u,f]=o.useState([]),[x,A]=o.useState(-1),[z,ae]=o.useState(""),[K,oe]=o.useState(!1),[C,W]=o.useState(!1),M=o.useRef(null),H="ProcessAssistantModal.v2",V=o.useCallback((t=[],r="")=>(t||[]).map(s=>s.type==="template"?{type:"template",templateId:s.templateDef?.id,slug:r}:s.type==="decision"?{type:"decision",options:(s.options||[]).map(a=>({label:a.label,next:a.next}))}:s.type==="assistant"||s.type==="user"?{type:s.type,text:s.text}:s),[]),L=o.useCallback((t={})=>{try{const r=M.current?.scrollTop??0,s={phase:g,selectedSlug:m,input:d,isMax:C,scrollTop:r,messages:V(u,m),ts:Date.now(),...t};localStorage.setItem(H,JSON.stringify(s))}catch{}},[g,m,d,C,u,V]),J=o.useCallback(()=>{try{const t=localStorage.getItem(H);if(!t)return null;const r=JSON.parse(t);return r&&typeof r=="object"?r:null}catch{return null}},[]),le=o.useCallback(()=>{try{localStorage.removeItem(H)}catch{}},[]),ce=1,[R,Y]=o.useState(null),[_,G]=o.useState(!1),[X,Q]=o.useState(""),$=async()=>{try{G(!0),Q("");const r=await fetch(`${N||"/processes/flows.json"}?v=${ce}`,{cache:"no-store"});if(!r.ok)throw new Error(`HTTP ${r.status}`);const s=await r.json();Y(s?.flows||{})}catch(t){console.error(t),Y({}),Q("load-error")}finally{G(!1)}};o.useEffect(()=>{(p?n!==!1:n)&&R===null&&!_&&$()},[n,p,R,_]);const T=o.useMemo(()=>{const t=k(d.trim());return t.length<3?[]:(Array.isArray(c)?c:[]).map(s=>({...s,hay:k([s.title,s.summary,s.slug,(s.tags||[]).join(" ")].join(" "))})).filter(s=>s.hay.includes(t)).slice(0,6)},[d,c]),Z=o.useCallback(()=>{const t=k(d.trim());if(!t)return null;const r=Array.isArray(c)?c:[];let s=r.find(a=>k(a.slug)===t)||r.find(a=>k(a.title)===t);return s||(s=r.find(a=>k(a.title).startsWith(t))||r.find(a=>(a.tags||[]).some(l=>k(l).startsWith(t))),s)?s:(s=r.find(a=>k([a.title,a.summary,a.slug,(a.tags||[]).join(" ")].join(" ")).includes(t)),s||null)},[d,c]),U=o.useCallback((t,r)=>{const s=(h?.[t]||[]).find(l=>l.id===r);if(s)return s;const a=(h?.common||[]).find(l=>l.id===r);if(a)return a;for(const l of Object.keys(h||{})){const b=(h[l]||[]).find(pe=>pe.id===r);if(b)return b}return null},[h]),ue=o.useCallback((t=[])=>(t||[]).map(r=>{if(r.type==="template"){const s=U(r.slug,r.templateId);return s?{type:"template",templateDef:s}:{type:"assistant",text:"Template indisponible."}}return r}),[U]),P=(t,r)=>{if(!t)return;const s=[];if(t.text&&s.push({type:"assistant",text:t.text}),t.templateId&&s.push({type:"template",templateDef:U(r,t.templateId)}),t.type!=="end"){if(t.options?.length)s.push({type:"decision",options:t.options});else if(t.next){f(l=>[...l,...s]);const a=R?.[r]?.nodes?.[t.next];a&&setTimeout(()=>P(a,r),0);return}}f(a=>[...a,...s])},ee=(t,{initialUserHeader:r=!0}={})=>{E(t),w("run");const a=(Array.isArray(c)?c:[]).find(b=>b.slug===t)?.title||t;if(f(r?[{type:"user",text:a}]:[]),_){f(b=>[...b,{type:"assistant",text:"Chargement des flows…"}]);return}if(!R||!R[t]){f(b=>[...b,{type:"assistant",text:"Aucun flow défini pour ce process pour le moment."}]);return}const l=R[t].nodes?.[R[t].start];if(!l){f(b=>[...b,{type:"assistant",text:"Flow invalide : nœud de départ introuvable."}]);return}P(l,t),setTimeout(()=>M.current?.scrollTo?.({top:999999,behavior:"smooth"}),50)},B=t=>{y("");const r=typeof t=="string"?t:t?.slug;r&&ee(r)},de=t=>{if(!t?.next||!m)return;const r=R?.[m]?.nodes?.[t.next];f(s=>{const a=[...s];for(let l=a.length-1;l>=0;l--)if(a[l].type==="decision"){a.splice(l,1);break}return a.push({type:"user",text:t.label}),a}),r&&setTimeout(()=>{P(r,m),setTimeout(()=>M.current?.scrollTo?.({top:999999,behavior:"smooth"}),30)},30)},D=()=>{w("idle"),E(""),f([]),A(-1),y(""),le()},he=()=>{!m||_||ee(m)};o.useEffect(()=>{if(!(p?n!==!1:n))return;const r=s=>{const a=T.length>0;if(a&&(s.key==="ArrowDown"&&(s.preventDefault(),A(l=>Math.min(l+1,T.length-1))),s.key==="ArrowUp"&&(s.preventDefault(),A(l=>Math.max(l-1,0))),s.key==="Enter")){s.preventDefault();const l=x>=0?T[x]:T[0];if(l)return B(l)}if(s.key==="Enter"&&!a&&d.trim()){const l=Z();if(l)return B(l);setTimeout(()=>ae(""),1400)}s.key==="Escape"&&q(),s.altKey&&(s.key==="h"||s.key==="H")&&(s.preventDefault(),D()),s.altKey&&(s.key==="m"||s.key==="M")&&(s.preventDefault(),W(l=>!l))};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[n,p,T.length,x,d,Z]);const te=ue;o.useLayoutEffect(()=>{if(!(p?n!==!1:n))return;const r=J();if(r)try{if(y(r.input||""),W(!!r.isMax),r.phase==="run"&&r.selectedSlug){E(r.selectedSlug),w("run");const s=te(r.messages||[]);f(s),requestAnimationFrame(()=>{const a=Number(r.scrollTop||0);Number.isFinite(a)&&M.current?.scrollTo?.({top:a,behavior:"auto"})})}else w("idle")}catch(s){console.warn("Restore failed",s)}},[n,p,J,te]),o.useEffect(()=>{(p?n!==!1:n)&&L()},[n,p,g,m,u,d,C,L]);const q=o.useCallback(()=>{L(),i?.()},[i,L]);o.useEffect(()=>{if(!(p?n!==!1:n))return;let r=null;const s=()=>{r&&cancelAnimationFrame(r),r=requestAnimationFrame(()=>L())},a=M.current;return a?.addEventListener?.("scroll",s,{passive:!0}),()=>a?.removeEventListener?.("scroll",s)},[n,p,L]);const me=e.jsxs("div",{className:"assistant-hero",children:[e.jsxs("div",{className:"hero-circle clip",children:[!K&&v&&e.jsx("img",{src:v,alt:"Wave",className:"hero-logo-clip",loading:"lazy",onError:()=>oe(!0)}),(K||!v)&&e.jsx("div",{className:"hero-fallback",children:"W"})]}),e.jsx("div",{className:"hero-title",children:"Ask anything about processes"}),e.jsx("div",{className:"hero-sub",children:"Tape un mot-clé pour trouver le bon process"}),e.jsx("div",{className:"chips",children:["Reset PIN","Déplafonnement","Dormancy Block"].map((t,r)=>{const s=Array.isArray(c)?c:[],a=s.find(l=>k(l.title)===k(t))||s.find(l=>k(l.title).includes(k(t)))||null;return e.jsx("button",{className:"chip",onClick:()=>a?B(a):y(t),title:t,children:t},r)})}),X&&e.jsxs("div",{className:"note-card warning mt-3",children:["Impossible de charger ",e.jsx("code",{children:"/processes/flows.json"}),".",e.jsx("button",{className:"btn btn-sm btn-outline-secondary ms-2",onClick:$,children:"Réessayer"})]})]}),se=e.jsxs("div",{className:"assistant-body",ref:M,style:{flex:1,minHeight:0,overflow:"auto"},children:[g==="idle"&&me,g==="run"&&e.jsx("div",{className:"chat-area",children:u.map((t,r)=>t.type==="assistant"?e.jsx(I,{role:"asst",children:e.jsx("div",{className:"msg-text",children:t.text})},r):t.type==="template"?e.jsx(I,{role:"asst",wide:!0,children:e.jsx(je,{def:t.templateDef})},r):t.type==="decision"?e.jsx(I,{role:"user",children:e.jsx("div",{className:"qr-panel",children:t.options.map((s,a)=>e.jsx("button",{className:"qr-btn",onClick:()=>de(s),children:s.label},a))})},r):t.type==="user"?e.jsx(I,{role:"user",children:e.jsx("div",{className:"msg-text user",children:t.text})},r):null)})]}),ne=e.jsxs("div",{className:"assistant-input-wrap ai",children:[z&&e.jsx("div",{className:"ai-toast",children:z}),e.jsxs("div",{className:"ai-input",children:[e.jsx("span",{className:"ai-input-icon","aria-hidden":"true",children:e.jsx(j.Search,{})}),e.jsx("input",{className:"ai-input-field",placeholder:"Ask me anything",value:d,onChange:t=>{y(t.target.value),A(-1),L({input:t.target.value})}}),g==="run"&&e.jsx("button",{className:"ai-input-restart",onClick:he,"aria-label":"Recommencer le flow",title:"Recommencer le flow",disabled:!m||_,children:e.jsx(j.Restart,{})}),e.jsx("button",{className:"ai-input-home",onClick:()=>{D()},"aria-label":"Accueil",title:"Accueil (Alt+H)",children:e.jsx(j.Home,{})})]}),T.length>0&&e.jsx("div",{className:"ai-suggest",children:T.map((t,r)=>e.jsxs("button",{className:`ai-suggest-item ${r===x?"active":""}`,onClick:()=>B(t),title:t.title,children:[e.jsx("div",{className:"ai-suggest-icon",children:e.jsx(j.File,{})}),e.jsxs("div",{className:"ai-suggest-texts",children:[e.jsx("div",{className:"ai-suggest-title",children:e.jsx(ie,{text:t.title,query:d})}),t.summary&&e.jsx("div",{className:"ai-suggest-sub",children:e.jsx(ie,{text:t.summary,query:d})}),Array.isArray(t.tags)&&t.tags.length>0&&e.jsx("div",{className:"ai-suggest-tags",children:t.tags.slice(0,3).map((s,a)=>e.jsx("span",{className:"ai-tag",children:s},a))})]}),e.jsx("span",{className:"ai-suggest-caret",children:e.jsx(j.ChevronRight,{})})]},t.slug))})]});return p?e.jsxs("div",{className:"assistant-root",style:{display:"flex",flexDirection:"column",height:"100%",minHeight:0},children:[se,ne]}):n?e.jsx("div",{className:"modal-overlay modal-overlay-glass",role:"dialog","aria-modal":"true",onClick:q,children:e.jsxs("div",{className:`modal-card qto-modal modal-elevated assistant-modal ${C?"is-max":""}`,onClick:t=>t.stopPropagation(),style:C?{width:"min(98vw, 1024px)",height:"min(95vh, 800px)",display:"flex",flexDirection:"column"}:{width:"min(96vw, 680px)",height:"min(88vh, 620px)",display:"flex",flexDirection:"column"},children:[e.jsxs("div",{className:"assistant-header",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[g==="run"&&e.jsx("button",{className:"btn btn-ghost px-2 assistant-back",onClick:D,"aria-label":"Retour",title:"Réinitialiser la session",children:e.jsx(j.ArrowLeft,{})}),e.jsx("span",{className:"fw-700",children:"Wave Digital AI Assist"}),_&&e.jsx("span",{className:"small text-muted ms-2",children:"· chargement…"}),X&&e.jsx("button",{className:"btn btn-link btn-sm text-danger ms-2 p-0",onClick:$,children:"Réessayer"})]}),e.jsxs("div",{className:"d-flex align-items-center gap-1",children:[e.jsx("button",{className:"btn btn-ghost px-2 assistant-home",onClick:t=>{t.stopPropagation(),D()},"aria-label":"Accueil",title:"Accueil (Alt+H)",children:e.jsx(j.Home,{})}),e.jsx("button",{className:"btn btn-ghost px-2 assistant-maximize",onClick:t=>{t.stopPropagation(),W(r=>!r),L({isMax:!C})},"aria-label":C?"Réduire":"Agrandir",title:(C?"Réduire":"Agrandir")+" (Alt+M)",children:C?e.jsx(j.Minimize,{}):e.jsx(j.Maximize,{})}),e.jsx("button",{className:"btn btn-ghost rounded-circle assistant-close",onClick:t=>{t.stopPropagation(),q()},"aria-label":"Fermer",title:"Fermer",children:e.jsx(j.Close,{})})]})]}),se,ne]})}):null}async function O(n){if(!n)return null;try{const i=await fetch(n,{cache:"no-store"});if(!i.ok)throw new Error(`HTTP ${i.status}`);return await i.json()}catch(i){return console.error("[Assist] fetchJson failed:",n,i),null}}async function ke(n){const i=await O(n);return i?i&&(i.templatesBySlug||i.processes)?{processes:Array.isArray(i.processes)?i.processes:[],templatesBySlug:i.templatesBySlug||{}}:i&&!Array.isArray(i)?{processes:[],templatesBySlug:i}:Array.isArray(i)?{processes:i,templatesBySlug:{}}:{processes:[],templatesBySlug:{}}:{processes:[],templatesBySlug:{}}}async function we(n){const i=await O(n);return i?Array.isArray(i)?i:Array.isArray(i.processes)?i.processes:[]:[]}async function be(n){const i=await O(n);if(!i||!i.flows)return[];try{return Object.entries(i.flows).map(([c,h])=>({slug:c,title:h?.title||c,summary:h?.summary||"",tags:h?.tags||[]}))}catch{return[]}}window.WaveAssist={async mount(n,i={}){const{open:c=!0,flowsUrl:h,templatesUrl:N,processesUrl:v,__logoUrl:S}=i,{processes:p,templatesBySlug:g}=await ke(N),w=await we(v);let d=w.length?w:p;if((!d||d.length===0)&&h){const x=await be(h);x.length&&(d=x)}const y=n.getRootNode&&n.getRootNode(),m=y&&y.host?y:null;if(m&&!m.__ASSIST_CSS__){const x=document.createElement("style");x.textContent=re,m.appendChild(x),m.__ASSIST_CSS__=!0}else if(!m){const x="__assist_css__";if(!document.getElementById(x)){const A=document.createElement("style");A.id=x,A.textContent=re,document.head.appendChild(A)}}const E=S&&String(S)||(typeof chrome<"u"&&chrome.runtime?.getURL?chrome.runtime.getURL("assets/logo.png"):new URL("assets/logo.png",import.meta.url).href),u=x=>e.jsx(ve,{...x,__flowsUrl:h,__logoUrl:E,__headerless:!0}),f=ge.createRoot(n);return f.render(e.jsx(u,{open:c,processes:d,templatesBySlug:g})),f}};
